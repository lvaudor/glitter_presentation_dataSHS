---
title: '`glitter` makes SPARQL'
subtitle: '`glitter`, un package R pour explorer et collecter des donn√©es du web s√©mantique'
author: "Lise Vaudor"
date: "21/10/2021"
output: 
  slidy_presentation:
    logo: img/logo_small.png
    css: styles.css    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE)
library(glitter)
```


# Projet: mon m√©tier

<!-- - approche non pas du point de vue du producteur de donn√©es mais plut√¥t de celle de l'utilisateur de donn√©es -->

![](img/im_dataSHS_2.jpg){width=1200px}

- **Analyste de donn√©es** dans un labo de g√©ographie (UMR 5600 Environnement Ville Soci√©t√©)

- R√¥le **p√©dagogique**: aider les coll√®gues √† **utiliser R** pour leurs analyses/valorisation (blog[üîó](http://perso.ens-lyon.fr/lise.vaudor/))

- Travail d'**appui √† la recherche** => d√©veloppement d'outils d'analyse, recueil de donn√©es du web (API, web-scraping...)

# Projet: Les donn√©es (participatives) du web

![](img/im_dataSHS_3.jpg){width=1200px}

- Int√©r√™t pour les **donn√©es du web** (r√©seaux sociaux, projet Wikimedia)
- D√©couverte du **web des donn√©es** (LOD: Linked Open Data) via les Wikidata 
    + donn√©es en **graphes**
    + **triplets** de donn√©es (s-v-o)

# Projet: RECIT

![](img/im_dataSHS_4.jpg){width=1200px}

Projet √©mergent ENS **RECIT** 

=> **R** pour l'**E**xploration et la **C**ollecte **I**nt√©gr√©e de **T**riplets de donn√©es 

- **stage M2** (2021)
- **d√©veloppement du package R glitter** (2021-2022)
- **prestation d√©v** (2022) pour am√©lioration du package glitter (stabilit√©, maintenance, d√©p√¥t sur CRAN)

# Projet: Cas d'√©tudes

![](img/im_dataSHS_5.jpg){width=1200px}

Recrutement de **Camille Scheffler** (stage M2) et exploration des Wikidata pour deux cas d'√©tudes:

- Les **jumelages** en Europe et dans le monde (Camille Scheffler, Ninon Briot,ATER ENS de Lyon)
- Le [**lobbyisme** aux USA](http://geoconfluences.ens-lyon.fr/informations-scientifiques/a-la-une/carte-a-la-une/lieux-de-pouvoir-lobbying-etats-unis) (Camille Scheffler, Florence Nussbaum, MCF ENS de Lyon)

# Projet: Package glitter

![](img/im_dataSHS_6.jpg){width=1200px}

En lien (et en parall√®le) aux cas d'√©tudes de Camille, **d√©veloppement du package R `glitter`**.
<br>

üéØ Objectifs:

Promouvoir l'usage (exploration, recueil, analyse) des LOD pour les chercheurs et √©tudiants usagers de R, en:

- facilitant l'**√©criture** des requ√™tes SPARQL
- facilitant l'**envoi** des requ√™tes
- facilitant le **nettoyage** des r√©sultats pour une analyse/valorisation ult√©rieure dans R

# Projet: Difficult√©s d'appropriation des LOD

<table><tr><td style="width:300">
![](img/image_RECIT.png){height=500px}
</td>
<td style="width:300">
- üëÄ ce qu'on appr√©hende directement: le **web documentaire**
- üí≠ difficult√©s li√©es √† la structure des donn√©es en **graphes**
    + visualisation souvent **incompl√®te** du graphe (mod√®le de donn√©es) 
    + m√©tadonn√©es int√©gr√©es aux donn√©es => il faut collecter les donn√©es pour comprendre ce qu'il y a dedans
    + Transformation en donn√©es **tabulaires** pour analyse ![](img/donnees_en_graphe.png){height=550px}

</td></tr></table>

# Projet: Difficult√©s de collecte

<table><tr><td width='30%'>

![](img/dialogue.jpg){height=800px}
</td><td width='70%'>

Importance des **exemples de requ√™tes SPARQL** pour explorer les bases de donn√©es

Or, le langage SPARQL est **sp√©cifique** √† 

- cette **√©tape** (dans l'analyse) du recueil de donn√©es
- ce **type** de donn√©es (les Linked Open Data)


![](img/sparql_to_r.png){width=1100px} 

</tr></table>

# Projet: avancement

Un **petit** projet ... (projet √©mergent ENS, 20 000 euros sur 3 ans). üêà

Un package **en cours de d√©veloppement** => am√©lioration √† pr√©voir d√©but 2022.

![](img/github_logo.png) Package installable et modifiable [ici](https://github.com/lvaudor/glitter).

# Wikidata: exploration c√¥t√© "documentaire"

![](img/Marius_et_Jeannette_WD.png){width=1400px}

[Lien](https://www.wikidata.org/wiki/Q3293881)

# Wikidata: exploration c√¥t√© "donn√©es" 

Passage par le **Wikidata Query Service (WDQS)**

![](img/WDQS_films_query.png){width=1400px}

[Lien](https://query.wikidata.org/#SELECT%20%3Ffilm%20%3FfilmLabel%20%0AWHERE%20%0A%7B%0A%20%20%3Ffilm%20wdt%3AP31%20wd%3AQ11424.%20%0A%20%20SERVICE%20wikibase%3Alabel%20%7B%20bd%3AserviceParam%20wikibase%3Alanguage%20%22%5BAUTO_LANGUAGE%5D%2Cen%22.%20%7D%0A%7D%0ALIMIT%2010)

<!-- bcp exp√©riment√© SPARQL et triplets de donn√©es par ce biais car existe exemples, documentation, et ressources accessibles par web documentaire -->

# Wikidata: focus sur le SPARQL endpoint (depuis le navigateur)

```{SPARQL}
SELECT ?film ?filmLabel 
WHERE {
  ?film wdt:P31 wd:Q11424.
  SERVICE wikibase:label {
    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". 
  } 
}
LIMIT 10
```

- ‚úçÔ∏è R√©daction de la requ√™te SPARQL
- ‚öôÔ∏è Ex√©cution depuis le SPARQL endpoint (navigateur web)
- üì• Affichage/T√©l√©chargement des r√©sultats 

# Wikidata: focus sur le code depuis R

```{r, eval=FALSE}
query='SELECT ?film ?filmLabel 
WHERE {
  ?film wdt:P31 wd:Q11424.
  SERVICE wikibase:label {
    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en".
  }
}'

result=purrr::quietly(WikidataQueryServiceR::query_wikidata)(query)
tib=result$r
```

- ‚úçÔ∏è R√©daction de la requ√™te SPARQL
- ‚öôÔ∏è Ex√©cution depuis R
- üéÅ R√©cup√©ration du tableau de r√©sultats en tant qu'objet R

üéØ Cha√Æne de traitement reproductible

# Wikidata: focus sur le code depuis R, avec glitter

```{r}
tib=spq_init() %>% 
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>% 
  spq_head(n=10) %>% 
  send()
```

- ‚úçÔ∏è  ‚öôÔ∏è R√©daction et envoi de commandes R
- üéÅ Recueil du tableau de r√©sultats en tant qu'objet R

```{r, echo=FALSE}
head(tib) %>% knitr::kable()
```

# Wikidata: avant-apr√®s glitter

Avant:

```{r, eval=FALSE}
query='SELECT ?film ?filmLabel WHERE {
  ?film wdt:P31 wd:Q11424.
  SERVICE wikibase:label {
    bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en".
  }
}
LIMIT 10'
result=WikidataQueryServiceR::query_wikidata(query)
tib=result$r
```

Apr√®s:
```{r, eval=FALSE}
tib=spq_init() %>% 
  spq_add("?film wdt:P31wd:Q11424", label="?film") %>% 
  spq_head(n=10) %>% 
  send()
```

# Ex. lieux de fiction: on peut r√©cup√©rer les donn√©es

```{r}
 tib=spq_init() %>%                                      # Initialise requ√™te puis
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%  # Ajoute triplet "?film est une instance de film" puis
  spq_add("?film wdt:P840 ?loc", label="?loc") %>%       # Ajoute triplet "?film a pour localisation narrative ?loc (√† √©tiqueter) puis
  spq_language("en,fr") %>%                              # Affiche les √©tiquettes en anglais, ou √† d√©faut en fran√ßais puis
  spq_head(n=10) %>%                                     # S√©lectionne les 10 premiers r√©sultats puis
  send()                                                 # Envoie la requ√™te
knitr::kable(tib)
```

# Ex. lieux de fiction: pas trop de donn√©es?

Combien de films ont la localisation narrative renseign√©e dans Wikidata?

```{r}
 tib=spq_init() %>%                                       # Initialise requ√™te puis
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%   # Ajoute triplet "?film est une instance de film" puis
  spq_add("?film wdt:P840 ?loc", label="?loc") %>%        # Ajoute triplet "?film a pour localisation narrative ?loc (√† √©tiqueter) puis
  spq_summarise(c("?n_films"="COUNT(?film)")) %>%         # R√©sume en comptant le nombre de films puis
  send()                                                  # Envoie la requ√™te
knitr::kable(tib)                                         # Montre la table
```

# Ex. lieux de fiction : on va restreindre un peu (g√©ographiquement) ...

```{r lf_1}
lf_1=spq_init() %>%                                         # Initialise requ√™te puis
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%     # Ajoute triplet "?film est une instance de film" puis
  spq_add("?film wdt:P840 ?loc", label="?loc") %>%          # Ajoute triplet "?film a pour localisation narrative ?loc (√† √©tiqueter) puis
  spq_add("?loc wdt:P625 ?coords",                          # Ajoute triplet "?loc a pour coordonn√©es spatiales ?coords" 
          within_box=list(southwest=c(3,43),                #         ... restreins pour que les coordonn√©es soient comprises
                          northeast=c(7,47))) %>%           #         ... dans un cadre d√©fini par ces deux points (S-O et N-E) puis
  spq_language("fr") %>%                                    # Etiquette de pr√©f√©rence en fran√ßais puis    
  send()                                                    # Envoie la requ√™te
```

Cette table comprend `r nrow(lf_1)` lignes. Voici les premi√®res:

```{r}
knitr::kable(lf_1 %>% head())
```


<!-- La r√©cup de la totalit√© des films localis√©s est possible (prend une 15aine de secondes) mais j'anticipe pour la production de la carte => je veux pas un jeu de donn√©es trop lourd -->


# Ex. lieux de fiction: et on enrichit!

```{r lf_2}
lf_2=spq_init() %>%                                       # Initialise requ√™te puis
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%   # Ajoute triplet "?film est une instance de film" puis
  spq_add("?film wdt:P840 ?loc", label="?loc") %>%        # Ajoute triplet "?film a pour localisation narrative ?loc (√† √©tiqueter) puis
  spq_add("?loc wdt:P625 ?coords",                        # Ajoute triplet "?loc a pour coordonn√©es spatiales ?coords"
          within_box=list(southwest=c(3,43),              #           ... restreins pour que les coordonn√©es soient comprises
                          northeast=c(7,47)))%>%          #           ... dans un cadre d√©fini par ces deux points (S-O et N-E) puis
  spq_add("?film wdt:P18 ?image", required=FALSE) %>%     # Ajoute triplet "?film a pour image d'illustration ?image" puis
  spq_add("?film wdt:P921 ?subject",                      # Ajoute triplet "?film a pour sujet ?subject" (info optionnelle)
          label="?subject", required=FALSE) %>%           #           ... √©tiquette ?subject puis
  spq_add("?film wdt:P577 ?date") %>%                     # Ajoute triplet "?film a √©t√© publi√© √† la date ?date puis
  spq_mutate(c("?year"="year(?date)")) %>%                # Ajoute une variable ?year qui corresond √† l'ann√©e de ?date puis
  spq_select("-?date") %>%                                # Enl√®ve la variable ?date puis
  spq_language("fr,en") %>%                               # Etiquette (de pr√©f√©rence en fran√ßais, √† d√©faut en anglais) puis
  send()                                                  # Envoie la requ√™te
```

Cette table comprend `r nrow(lf_2)` lignes. Voici les premi√®res:

```{r}
knitr::kable(lf_2 %>% head())
```

# Ex. lieux de fiction: requ√™te SPARQL

```{r, echo=FALSE}
query=spq_init() %>%
  spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%
  spq_add("?film wdt:P840 ?loc", label="?loc") %>%
  spq_add("?loc wdt:P625 ?coords",
          within_box=list(southwest=c(3,43),northeast=c(7,47)))%>%
  spq_add("?film wdt:P18 ?image", required=FALSE) %>%
  spq_add("?film wdt:P921 ?subject",
          label="?subject", required=FALSE) %>% 
  spq_add("?film wdt:P577 ?date") %>%
  spq_mutate(c("?year"="year(?date)")) %>%
  spq_select("-?date") %>% 
  spq_language("fr,en") %>% 
  build_sparql() %>% 
  cat() 
```

# Ex. lieux de fiction: nettoyage sous R

```{r}
lf_c=lf_2 %>%                                                 # Consid√®re lf_2 puis
  select(film,ends_with("Label"),coords,image,year) %>%       # S√©lectionne ces variables (dont "....Label") puis
  group_by(film,coords,image,locLabel,filmLabel) %>%          # Groupe par ces variables puis 
  summarise(subjectLabel=stringr::str_c(unique(subjectLabel), # R√©sume par groupe: le sujet (sur une seule ligne)   
                                        collapse=", "),       #     ... en s√©parant les √©l√©ments par ", "
            year=min(year),                                   #     ... et l'ann√©e comme minimum des ann√©es de sortie   
            .groups="drop")                                   # D√©groupe
```

Cette table comprend `r nrow(lf_c)` lignes. Voici les premi√®res:

```{r}
knitr::kable(head(lf_c))
```

# Ex. lieux de fiction: pr√©paration des donn√©es pour carto

Pr√©paration d'une fen√™tre "pop-up" (langage html)

```{r}
lf_m =lf_c %>% 
  transform_wikidata_coords("coords") %>% 
  mutate(popup=glue::glue("<h1>{filmLabel}<a href={film} target='_blank'>üîó</a></h1>
                           <li>Lieu: {locLabel}</li>
                           <li>Ann√©e de sortie: {year}</li>")) %>% 
  mutate(popup=case_when(is.na(image)~popup,
                         !is.na(image)~glue::glue("{popup}
                                                  <img src='{image}' height='200'>"))) %>% 
  mutate(popup=case_when(is.na(subjectLabel)~popup,
                         !is.na(subjectLabel)~glue::glue("{popup}
                                                         <li>Th√®mes: {subjectLabel}</li>")))
```

# Ex. lieux de fiction: production d'une carte

<table><tr><td width='50%'>

```{r build_map}
library(leaflet)
# D√©finition d'une √©chelle color√©e
# (en fonction de date de sortie)
pal <- colorNumeric(c("red", "green", "blue"),        
                    c(1895,1950,1970,1990,2010,2021))
# Cr√©ation de la carte
map=leaflet(lf_m) %>% # d√©f carte
  addTiles() %>%      # ajout fond de carte
  addCircleMarkers(col=~pal(year),
                   ~lng, ~lat,
                   popup = ~popup,
                   clusterOptions = markerClusterOptions())
```


</td><td width='50%'>
```{r}
map
```
</td></tr></table>

# Package glitter: vue d'ensemble

![](img/tidyverse_logo.jpeg){width=150px} Un package qui suit quelques principes du tidyverse...

- usage du **pipe" %>%**
- fonctions √† **pr√©fixe** (ici `spq_`)
- vise √† la **facilit√© d'utilisation** (d√©composition en √©tapes √©l√©mentaires)
- **documentation** via des **vignettes** (par exemple [ici](http://perso.ens-lyon.fr/lise.vaudor/Rpackages/glitter/articles/glitter_for_Wikidata.html))

# Package glitter: fonctions principales

<table><tr>
<td style="width:50%">

**Fonctions de base:**

- spq_init() pour initier une requ√™te
- spq_add() pour rajouter un triplet
- send() pour envoyer la requ√™te
</td>
<td>
![](img/dplyr_logo.jpeg){width=150px} 
Fonctions notamment inspir√©es de dplyr
(pour la **manipulation de donn√©es**)

- spq_filter()
- spq_select()
- spq_arrange()
- spq_mutate()
- spq_group_by()
- spq_summarise()
</td>
</tr></table>

# Package glitter: spq_filter()

![](img/dplyr_filter.png) **FILTRER** les r√©sultats renvoy√©s

Articles avec "wikidata" dans le titre (en anglais):

```{r spq_filter}
spq_init() %>%
  spq_add("?item wdt:P31 wd:Q13442814") %>%                  # ?item est une instance d'article scientifique
  spq_add("?item rdfs:label ?itemTitle") %>%                 # ?item a pour titre ?itemTitle
  spq_filter("contains(lcase(?itemTitle),'wikidata')") %>%   # <= ce titre contient (en minuscules) "wikidata"
  spq_filter("lang(?itemTitle)='en'") %>%                    # <= on filtre pour ne garder que les titres en anglais
  spq_head(n=5) %>%
  send() %>% 
  knitr::kable()
```

# Package glitter: spq_mutate()

![](img/dplyr_mutate.png) **MODIFIER** les r√©sultats renvoy√©s.

Donn√©es sur films, date de sortie ET ann√©e de sortie

```{r spq_mutate}
spq_init() %>%
 spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%   # ?film est un instance de film
 spq_add("?film wdt:P577 ?date") %>%                     # ?film est sorti √† la date ?date
 spq_mutate(c("?year"="year(?date)")) %>%                # <= ajoute variable ?year correspondant √† l'ann√©e de la date
 spq_head(5) %>% 
 send() %>% 
 knitr::kable()
```

# Package glitter: spq_select()

![](img/dplyr_arrange.png) **SELECTIONNER** les variables renvoy√©es

Donn√©es sur films, localisation narrative, date de sortie ET ann√©e de sortie

```{r spq_select}
spq_init() %>%
 spq_add("?film wdt:P31 wd:Q11424", label="?film") %>%   # ?film est une instance de film
 spq_add("?film wdt:P577 ?date") %>%                     # ?film est sorti √† la date ?date
 spq_mutate(c("?year"="year(?date)")) %>%                # ?year est l'ann√©e correspondant √† ?date
 spq_select("-?date") %>%                                # <= on retire la variable ?date
 spq_head(5) %>% 
 send() %>% 
 knitr::kable()
```

# Package glitter: spq_arrange()

![](img/dplyr_arrange.png) **ORDONNER** les r√©sultats renvoy√©s.

Personnes n√©es ou habitant √† New York qui font l'objet du plus grand nombre d'articles Wikimedia.

```{r spq_arrange}
spq_init() %>%
  spq_add("?pers wdt:P31 wd:Q5",label="?item") %>%        # ?pers est une instance de personne
  spq_add("?pers wdt:P19/wdt:P131* wd:Q60") %>%           # qui est n√©e ou est situ√©e √† New-York
  spq_add("?pers wikibase:sitelinks ?sitelinks") %>%      # ?personne fait l'objet de n liens dans le projet Wikimedia
  spq_arrange(c("desc(?sitelinks)")) %>%                  # <= classe par ordre d√©croissant de n
  spq_head(n=5) %>%
  send() %>% 
  knitr::kable()
```

# Package glitter: spq_group_by, spq_summarise()

![](img/dplyr_summarise.png) **GROUPER** et **RESUMER** les r√©sultats renvoy√©s.

Communes d'Auvergne-Rh√¥ne-Alpes qui ont √©t√© supprim√©es lors de la r√©forme territoriale (nombre par d√©partement).

```{r spq_summarise}
tib=spq_init() %>%
  spq_add("?com wdt:P31 wd:Q21869758") %>%          # ?com est une instance de commune disparue
  spq_add("?com wdt:P131* wd:Q18338206") %>%        # ?com est situ√©e dans un
  spq_add("?com wdt:P131* ?dep", label="?dep") %>% 
  spq_add("?dep wdt:P31 wd:Q6465") %>% 
  spq_group_by(c("?dep", "?depLabel")) %>% 
  spq_summarise(c("?ncomsup"="count(?com)")) %>%
  send()
```

# Autres endpoints: dbpedia

```{r}
tib=spq_init() %>% 
  spq_prefix(prefixes=c(dbo="http://dbpedia.org/ontology/")) %>% 
  spq_add("?person rdfs:label 'David Bowie'@en")  %>% 
  spq_add("?person dbo:birthPlace ?place") %>% 
  send("https://dbpedia.org/sparql")
```

```{r}
tib=spq_init() %>% 
  spq_prefix(prefixes=c(dbo="http://dbpedia.org/ontology/")) %>%
  spq_add("?person dbo:birthPlace ?place") %>% 
  spq_add("?person dbo:profession ?job") %>% 
  spq_add("?job rdfs:label ?jobLabel") %>% 
  spq_filter(c("LANG(?jobLabel)='en'")) %>% 
  spq_add("?place rdfs:label 'Lyon'@en") %>% 
  spq_head(10) %>% 
  send("https://dbpedia.org/sparql")
```

# Autres endpoints: hal

# Autres endpoints: SymoGih

# Autres endpoints: pas (forc√©ment) besoin de pr√©fixer!

Montrer requ√™te SPARQL "normale" => avec pr√©fixes

Montrer usual_prefixes

Montrer usual endpoints (aide de send())

```{r, eval=FALSE, echo=FALSE} 
# ajouter aux issues glitter: pkoi Invalid Tag Name
tib=spq_init() %>% 
  spq_prefix(prefixes=c(dbo="http://dbpedia.org/ontology/")) %>% 
  spq_add("?person rdfs:label 'David Bowie'@en")  %>% 
  spq_add("?person ?p ?o") %>%
  spq_head(100) %>% 
  send("https://dbpedia.org/sparql")
```


# Package glitter: pr√©fixes et endpoints

```{r}
usual_prefixes
```


# Ex. 2: arbre g√©n√©alogique de Louis XVI

```{r, eval=FALSE}
people=spq_init() %>%
  spq_add("?louis16 is wd:Q7732") %>%
  spq_add("?louis16 (wdt:P22*/wdt:P25*) ?who", label="?who") %>%
  spq_select("-?louis16") %>%
  spq_language("fr") %>%
  send()%>%
  mutate(num=1:n())
```

```{r, eval=FALSE}
list_people=people %>%
  clean_wikidata_table() %>%
  pull(who)

links=spq_init() %>%
  spq_add("?person %in% {list_people}") %>%
  spq_add("?person wdt:P22 ?p_father") %>%
  spq_add("?person wdt:P25 ?p_mother", label="?p_mother") %>% 
  spq_language("fr") %>%
  send() 

list_people=bind_rows(people,
                      links %>%
                        select(who=p_mother,whoLabel=p_motherLabel))


links=links %>%
  select(person,p_father,p_mother) %>% 
  tidyr::pivot_longer(cols=starts_with("p_"), 
                      names_to="which_parent",
                      values_to="parent")




linknew=links %>% 
  left_join(people %>%
              select(who,num_person=num),
            by=c("person"="who")) %>% 
  left_join(people %>% 
              select(who,num_parent=num),
            by=c("parent"="who"))
```


```{r, eval=FALSE}
library(tidygraph)
library(ggraph)
tib_g=tidygraph::tbl_graph(nodes=people,
                           edges=linksnew) 
tib_g %>% ggraph(layout="sugiyama")

```



# ANNEXES

Recrutement de Camille Scheffler (stage M2) et exploration des Wikidata pour deux cas d'√©tudes:

- Les jumelages en Europe et dans le monde (Ninon Briot, ENS de Lyon)
- Le [lobbyisme aux USA](http://geoconfluences.ens-lyon.fr/informations-scientifiques/a-la-une/carte-a-la-une/lieux-de-pouvoir-lobbying-etats-unis)

![](img/carte_lobbies.png){width=800px}

